// A simple script to fix the broken fonts in PDF files generated by S22PDF.

if (scriptArgs.length != 2) {
	print("usage: mutool run fix-s22pdf.js input.pdf output.pdf");
	quit();
}

var doc = new PDFDocument(scriptArgs[0]);

var font = new Font("zh-Hans");
var SimSun = doc.addCJKFont(font, "zh-Hans", "H", "serif");
var SimHei = doc.addCJKFont(new Font('./simhei.ttf'), "zh-Hans", "H", "sans-serif");
var SimKai = doc.addCJKFont(new Font('./simhei.ttf'), "zh-Hans", "H", "sans-serif");
SimSun.Encoding = 'GBK-EUC-H';
print(SimSun.BaseFont);
SimHei.Encoding = 'GBK-EUC-H';
print(SimHei.BaseFont);
SimKai.Encoding = 'GBK-EUC-H';
print(SimKai.BaseFont);

var MAP = {
	"/#CB#CE#CC#E5": SimSun, // SimSun
	"/#BA#DA#CC#E5": SimHei, // SimHei
	"/#BF#AC#CC#E5_GB2312": SimSun, // SimKai
	"/#B7#C2#CB#CE_GB2312": SimHei, // SimFang
	"/#C1#A5#CA#E9": SimSun, // SimLi
	"/SimSun": SimSun,
	"/SimHei": SimHei,
	"/KaiTi": SimKai,
}

var i, n = doc.countPages();
for (i = 0; i < n; ++i) {
	var fonts = doc.findPage(i).Resources.Font;
	fonts.forEach(function (name, font) {
		if (font.BaseFont in MAP && font.Encoding == 'WinAnsiEncoding')
            fonts[name] = MAP[font.BaseFont];
	});
}

doc.save(scriptArgs[1]);
